<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>UX/UI + Agile Master Board ‚Äî Premium</title>
<meta name="description" content="Tablero premium UX/UI + Agile ‚Äî HTML/CSS/JS (vanilla)."/>
<style>
  /* -------------------- PALETA & TIPOGRAF√çA -------------------- */
  :root{
    --bg: #F7F3E9;            /* crema - page bg */
    --card:#FFFFFF;
    --muted:#6b6f76;
    --accent-ux:#3A5FCD;      /* azul elegante */
    --accent-lav:#C3B9FF;     /* lavanda */
    --accent-cream:#F7F3E9;   /* crema */
    --accent-grey:#DDE1E7;    /* gris suave */
    --title:#1C1F2B;         /* negro azulado */
    --mint:#CFF7E3;          /* verde menta tips */
    --radius:14px;
    --shadow: 0 12px 30px rgba(23,28,44,0.08);
  }
  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif; background:var(--bg); color:var(--title); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
  header{padding:26px 28px; background: linear-gradient(180deg, #ffffff 0%, #fbfcff 100%); box-shadow: 0 2px 6px rgba(20,20,30,0.03); position:sticky; top:0; z-index:60;}
  header .wrap{max-width:1320px;margin:0 auto; display:flex; gap:18px; align-items:center; justify-content:space-between;}
  header h1{margin:0;font-size:20px;color:var(--title);}
  header p{margin:4px 0 0;color:var(--muted); font-size:13px; max-width:780px;}
  .header-frame{background:var(--card); border-radius:12px; padding:16px; box-shadow: var(--shadow); border:1px solid rgba(20,20,30,0.03);}

  /* board wrapper (scrollable) */
  #boardWrap{height:calc(100vh - 104px); overflow:auto; padding:24px; box-sizing:border-box;}
  #board{position:relative; width:1600px; min-height:1100px; margin:0 auto; background:transparent; border-radius:12px;}

  /* SVG layer for connectors */
  svg#connectors{position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; overflow:visible; z-index:1;}

  /* Node base */
  .node{
    position:absolute;
    min-width:260px;
    max-width:380px;
    background:var(--card);
    padding:14px 16px;
    border-radius:12px;
    box-shadow:0 10px 30px rgba(20,30,50,0.06);
    cursor:grab;
    user-select:none;
    transition:transform .16s ease, box-shadow .16s ease, border-color .12s ease;
    border:2px solid transparent;
    z-index:10;
  }
  .node:active{cursor:grabbing;}
  .node .title{font-size:15px; font-weight:700; color:var(--title); margin-bottom:6px;}
  .node .subtitle{font-size:12px;color:var(--muted); margin-bottom:8px;}

  /* styles by block type */
  .node.ux{border-left:6px solid var(--accent-ux);}
  .node.lav{border-left:6px solid var(--accent-lav);}
  .node.prac{border-left:6px solid #FFD88A;} /* warm */
  .node.ui{border-left:6px solid #6AD1A8;}
  .node.agile{border-left:6px solid #F9A33C;}
  .node.central{width:720px; left:440px; top:40px; border-radius:16px; background:linear-gradient(180deg,#ffffff,#f1f6ff); box-shadow:0 18px 50px rgba(20,30,70,0.06); padding:20px; border:2px solid rgba(58,95,205,0.06); }

  /* collapsed vs open content */
  .node .content{display:none; margin-top:8px; color:#222; font-size:13px; line-height:1.35;}
  .node.open{border-color:rgba(58,95,205,0.18); transform:translateY(-8px) scale(1.01); box-shadow:0 22px 60px rgba(24,40,80,0.09); z-index:50;}
  .node.open .content{display:block;}

  .node .steps{margin:8px 0 0 18px; padding:0;}
  .node .steps li{margin:8px 0; font-size:13px;}
  .node .note{margin-top:10px; padding:10px; border-radius:10px; font-size:13px; box-shadow:0 6px 22px rgba(10,20,30,0.04);}

  /* sticky note styles (different colors) */
  .sticky-lav{background:linear-gradient(180deg,#F2EEFF,#ECE0FF); border-left:6px solid var(--accent-lav); color:var(--title);}
  .sticky-blue{background:linear-gradient(180deg,#EEF4FF,#E6F0FF); border-left:6px solid var(--accent-ux); color:var(--title);}
  .sticky-cream{background:linear-gradient(180deg,#FFFDF6,#FFF5E0); border-left:6px solid #FFD88A; color:var(--title);}
  .sticky-mint{background:linear-gradient(180deg,#F6FFF6,#E9FFF0); border-left:6px solid var(--mint); color:var(--title);}

  .tools{margin-top:8px; font-size:12px; color:var(--muted);}
  .tools b{color:var(--title);}

  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;margin-right:8px;background:var(--accent-grey); color:var(--title);}

  /* legend & controls */
  .legend{position:absolute; left:24px; top:24px; z-index:80; background:rgba(255,255,255,0.95); padding:12px;border-radius:10px; box-shadow:0 8px 30px rgba(10,20,30,0.04); font-size:13px;}
  .legend .row{display:flex; gap:8px; align-items:center; margin:6px 0;}
  .sw{width:12px;height:12px;border-radius:4px;}

  .controls{position:absolute; right:24px; top:24px; z-index:80; display:flex; gap:8px;}
  .btn{background:#fff; border:1px solid rgba(20,20,30,0.06); padding:8px 12px; border-radius:10px; font-size:13px; cursor:pointer; box-shadow:0 8px 20px rgba(10,20,30,0.03);}
  .btn:active{transform:translateY(1px);}

  /* highlights */
  .line{stroke:var(--accent-grey); stroke-width:2.2; opacity:0.95; transition:stroke .18s ease, stroke-width .18s ease, opacity .18s;}
  .line.highlight{stroke:var(--accent-ux); stroke-width:3.6; opacity:1;}
  .node.highlight{box-shadow:0 26px 70px rgba(40,80,200,0.08); transform:scale(1.02);}

  /* helper bottom */
  .help{position:absolute; left:24px; bottom:24px; z-index:80; background:rgba(255,255,255,0.95); padding:12px;border-radius:10px; font-size:13px; box-shadow:0 8px 30px rgba(10,20,30,0.04); max-width:360px;}

  /* responsive board sizes */
  @media(max-width:1000px){
    #board{width:1200px; min-height:1400px;}
    .node{min-width:230px;}
    .node.central{width:640px; left:260px;}
  }
  @media(max-width:680px){
    #board{width:980px; min-height:1800px;}
    .legend{display:none;}
  }
</style>
</head>
<body>
  <header>
    <div class="wrap header-frame" role="banner" aria-label="Encabezado">
      <div>
        <h1>üéØ UX/UI + Agile Master Board</h1>
        <p>Flujo profesional: Investigaci√≥n ‚Üí Ideaci√≥n ‚Üí Wireframes ‚Üí Prototipado ‚Üí Testeo ‚Üí Iteraci√≥n ‚Üí Entrega</p>
      </div>
      <div style="text-align:right; font-size:13px; color:var(--muted)">
        Premium whiteboard ‚Ä¢ Notion-like palette
      </div>
    </div>
  </header>

  <div id="boardWrap" aria-live="polite">
    <div id="board" role="application" aria-label="Tablero UX UI Agile">
      <!-- SVG connectors -->
      <svg id="connectors" aria-hidden="true"></svg>

      <!-- legend and controls -->
      <div class="legend" aria-hidden="false">
        <div style="font-weight:700;margin-bottom:6px">Leyenda ‚Ä¢ Paleta</div>
        <div class="row"><span class="sw" style="background:var(--accent-ux)"></span> UX</div>
        <div class="row"><span class="sw" style="background:var(--accent-lav)"></span> Research / Sticky</div>
        <div class="row"><span class="sw" style="background:var(--accent-cream)"></span> Wireframes / Prototipos</div>
        <div class="row"><span class="sw" style="background:var(--mint)"></span> Tips</div>
      </div>

      <div class="controls" aria-hidden="false">
        <button class="btn" id="reset">üîÅ Restaurar posiciones</button>
        <button class="btn" id="fit">üéØ Centrar</button>
      </div>

      <!-- help -->
      <div class="help" aria-hidden="false">
        <b>C√≥mo usar</b><br>
        ‚Ä¢ Arrastra nodos para reorganizar el tablero.<br>
        ‚Ä¢ Haz clic en un nodo para abrirlo; abre sus nodos conectados.<br>
        ‚Ä¢ Presiona <kbd>Esc</kbd> para cerrar todos. Guardado autom√°tico de posiciones.
      </div>

      <!-- Nodes will be injected by JS -->
    </div>
  </div>

<script>
/* -------------------- NODES DATA (contenido premium) -------------------- */
const nodesData = [
  {
    id:'central',
    title:'üìå INICIO ‚Äî ROADMAP GENERAL',
    type:'central',
    x:440, y:30,
    connections:['uxResearch','insights','wireframes','prototypes','testing','agile'],
    steps:[
      'Investigaci√≥n ‚Üí Ideaci√≥n ‚Üí Wireframes',
      'Prototipado ‚Üí Testeo ‚Üí Iteraci√≥n ‚Üí Entrega'
    ],
    tools:`<div class="sticky-blue note">Marco grande: T√≠tulo y subt√≠tulo con roadmap general. Usa esto como ancla del board.</div>`,
    note:`<div class="sticky-cream note">Usa este bloque para definir objetivos del sprint y KPIs (ej. conversi√≥n, retenci√≥n).</div>`
  },

  /* 2. UX Research */
  {
    id:'uxResearch',
    title:'üîç UX Research ‚Äî Investigaci√≥n del usuario',
    type:'lav',
    x:80, y:170,
    connections:['insights','wireframes'],
    steps:[
      'Preguntas clave: ¬øQu√© problema? ¬øQui√©n lo sufre? ¬øC√≥mo lo resuelve hoy? ¬øQu√© siente?',
      'M√©todos: entrevistas 1:1, encuestas, benchmarking, analytics, mapas de empat√≠a',
      'Output: personas, journey actual, insights priorizados'
    ],
    tools:`<div class="sticky-lav note"><b>Sticky ‚Äî Preguntas clave</b><br>¬øQu√© problema real quiero resolver?<br>¬øQui√©n sufre este problema?<br>¬øQu√© limita al usuario?</div>`,
    note:`<div class="sticky-blue note"><b>M√©todos</b><br>Entrevistas ‚Ä¢ Encuestas ‚Ä¢ Hotjar ‚Ä¢ GA ‚Ä¢ Miro / FigJam para workshops</div>`
  },

  /* 3. Insights & Personas */
  {
    id:'insights',
    title:'üë§ Insights & Personas',
    type:'ux',
    x:340, y:200,
    connections:['uxResearch','wireframes'],
    steps:[
      'Crea 2‚Äì3 personas prioritarias con foto y contexto',
      'Mapa de empat√≠a (qu√© piensa, siente, dice, hace)',
      'Journey map con etapas, acciones, emociones y puntos cr√≠ticos'
    ],
    tools:`<div class="note sticky-cream"><b>Plantilla Persona:</b> Nombre ‚Ä¢ Objetivos ‚Ä¢ Dolor ‚Ä¢ H√°bitos ‚Ä¢ Oportunidades</div>`,
    note:`<div class="sticky-mint note"><b>Tip premium</b><br>Empieza las decisiones visuales con evidencia: datos + heur√≠sticas.</div>`
  },

  /* 4. Wireframes */
  {
    id:'wireframes',
    title:'üü´ Wireframes ‚Äî Baja fidelidad',
    type:'prac',
    x:620, y:160,
    connections:['prototypes','insights'],
    steps:[
      'Blanco y negro: enfoque en arquitectura y contenido',
      'Crea 3 variaciones por pantalla (A/B r√°pido)',
      'Usa layout grid 8pt; define jerarqu√≠a y patrones'
    ],
    tools:`<div class="sticky-cream note"><b>Reglas</b><br>Empieza simple ‚Ä¢ No tipograf√≠as finales ‚Ä¢ Test interno r√°pido</div>`,
    note:`<div class="sticky-mint note"><b>Tip</b><br>Genera wireframes con plantillas para acelerar (Figma, Balsamiq).</div>`
  },

  /* 5. Prototypes */
  {
    id:'prototypes',
    title:'üé® Prototipos en Figma ‚Äî Alta fidelidad',
    type:'ui',
    x:920, y:200,
    connections:['testing','wireframes'],
    steps:[
      'Define tokens: color, spacing, typography',
      'Crea components y variants (botones, inputs, cards)',
      'Usa Auto Layout y nombres claros en capas'
    ],
    tools:`<div class="note sticky-blue"><b>Figma Tips</b><br>Auto-layout (Shift+A) ‚Ä¢ Components ‚Ä¢ Variants ‚Ä¢ Plugins: Content Reel, Iconify, Stark</div>`,
    note:`<div class="sticky-mint note"><b>Pro Tip</b><br>Smart Animate solo si aporta claridad; usa Component Properties para reducir duplicaci√≥n.</div>`
  },

  /* 6. Testing */
  {
    id:'testing',
    title:'üß™ Testing UX ‚Äî Pruebas con usuarios',
    type:'lav',
    x:920, y:480,
    connections:['prototypes','agile'],
    steps:[
      'Define tareas cr√≠ticas y flujos principales',
      'Mide tiempo, errores y observaciones cualitativas',
      'Recopila hallazgos y prioriza por impacto/esfuerzo'
    ],
    tools:`<div class="sticky-lav note"><b>Herramientas:</b> Maze, Lookback, UsabilityHub</div>`,
    note:`<div class="sticky-mint note"><b>Loop</b><br>Investigaci√≥n ‚Üí Prototipo ‚Üí Test ‚Üí Mejora ‚Üí Re-test</div>`
  },

  /* 7. Agile */
  {
    id:'agile',
    title:'üåÄ Agile & Scrum ‚Äî Organizaci√≥n',
    type:'agile',
    x:520, y:560,
    connections:['wireframes','testing','handoff'],
    steps:[
      'Sprint Planning: prioriza por valor/esfuerzo',
      'Daily Standup: 15 minutos ‚Äî foco en bloqueos',
      'Design QA: checklist visual y accesibilidad'
    ],
    tools:`<div class="note sticky-blue"><b>Herramientas:</b> Jira, ClickUp, Confluence, Slack</div>`,
    note:`<div class="sticky-cream note"><b>Tip</b><br>Usa whiteboard con stickies rojos para impedimentos y verdes para soluciones.</div>`
  },

  /* 8. Handoff / Entrega */
  {
    id:'handoff',
    title:'üîó Handoff ‚Äî Dev Mode / Zeplin',
    type:'ux',
    x:320, y:640,
    connections:['agile'],
    steps:[
      'Tokens + Components documentados',
      'Assets exportados como SVG/PNG y specs claros',
      'Checklist de entrega: accesibilidad, tests, docs'
    ],
    tools:`<div class="note sticky-cream"><b>Handoff</b><br>Figma Dev Mode o Zeplin ‚Ä¢ Tokens ‚Ä¢ README de componentes</div>`,
    note:`<div class="sticky-mint note"><b>Tip</b><br>Incluye ejemplos de interacciones y estados (hover, focus, error).</div>`
  },

  /* 9. Heuristics */
  {
    id:'heuristics',
    title:'üîÆ Heur√≠sticas UX ‚Äî Norman & Nielsen',
    type:'ux',
    x:80, y:640,
    connections:['uxResearch'],
    steps:[
      'Visibilidad del estado del sistema',
      'Control y libertad del usuario',
      'Consistencia y est√°ndares',
      'Prevenci√≥n de errores; reconocer > recordar'
    ],
    tools:`<div class="sticky-cream note"><b>Checklist heur√≠stico</b><br>Prioriza 10 heur√≠sticas clave para revisi√≥n r√°pida</div>`,
    note:`<div class="sticky-mint note">Aplica heur√≠sticas como filtro antes de pasar a UI.</div>`
  },

  /* 10. Laws of UX */
  {
    id:'laws',
    title:'‚öñÔ∏è Laws of UX ‚Äî Leyes psicol√≥gicas',
    type:'lav',
    x:1120, y:80,
    connections:['prototypes','ui'],
    steps:[
      'Hick: reduce opciones',
      'Fitts: targets grandes y cercanos',
      'Miller: agrupa informaci√≥n',
      'Pareto: prioriza el 20% de funciones'
    ],
    tools:`<div class="sticky-lav note"><b>Sticky</b><br>Von Restorff ‚Ä¢ Proximidad ‚Ä¢ Ley de Pareto</div>`,
    note:`<div class="sticky-mint note"><b>Tip</b><br>Aplica estas leyes para decisiones r√°pidas en el dise√±o visual.</div>`
  },

  /* 11. Wireframe rules (additional) */
  {
    id:'wfRules',
    title:'üéõÔ∏è Reglas de Wireframe',
    type:'prac',
    x:1120, y:340,
    connections:['wireframes'],
    steps:[
      'Usa grids y spacing constante',
      'Prioriza contenido sobre ornamentaci√≥n',
      'Valida la arquitectura de la informaci√≥n'
    ],
    tools:`<div class="sticky-cream note"><b>Reglas</b><br>3 variaciones, prioridad en contenido, usa synoptic lists</div>`,
    note:`<div class="sticky-mint note">Plantillas de wireframe + checklist de validaci√≥n.</div>`
  },

  /* 12. Master Checklist */
  {
    id:'master',
    title:'‚úÖ MASTER CHECKLIST ‚Äî Flujo completo',
    type:'lav',
    x:740, y:820,
    connections:['agile','handoff'],
    steps:[
      'Investigaci√≥n hecha',
      'Personas creadas',
      'Journey completado',
      'HMW & problem statement',
      'Wireframes y prototipo',
      'User tests y priorizaci√≥n',
      'UI final y tokens',
      'Handoff y Sprint Review'
    ],
    tools:`<div class="sticky-mint note"><b>Checklist</b><br>Usala en cada sprint antes del release.</div>`,
    note:`<div class="sticky-cream note"><b>Tip</b><br>Marca cada item con evidencia (link a doc / test).</div>`
  }
];

/* -------------------- RENDER & INTERACTIVITY (Vanilla) -------------------- */
const board = document.getElementById('board');
const svg = document.getElementById('connectors');
const nodes = {};
const lines = [];

function escapeHtml(text){
  return text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
}

/* Create DOM node for each data item */
function createNode(n){
  const el = document.createElement('article');
  el.className = 'node ' + (n.type || '');
  el.dataset.id = n.id;
  el.setAttribute('tabindex','0');
  el.style.left = (n.x || 80) + 'px';
  el.style.top = (n.y || 120) + 'px';

  const title = document.createElement('div');
  title.className = 'title';
  title.innerHTML = escapeHtml(n.title);
  el.appendChild(title);

  const subtitle = document.createElement('div');
  subtitle.className = 'subtitle';
  subtitle.innerHTML = n.type === 'central' ? 'Roadmap general' : (n.type || '');
  el.appendChild(subtitle);

  // content
  const content = document.createElement('div');
  content.className = 'content';
  const stepsHtml = (n.steps || []).map(s => `<li>${escapeHtml(s)}</li>`).join('');
  content.innerHTML = `
    <ol class="steps" aria-hidden="true">${stepsHtml}</ol>
    <div class="tools">${n.tools || ''}</div>
    <div class="note">${n.note || ''}</div>
  `;
  el.appendChild(content);

  // toggle on click
  el.addEventListener('click', (evt) => {
    // prevent click after drag
    if(el.dataset.dragging === 'true'){ el.dataset.dragging = 'false'; return; }
    toggleNode(n.id, true);
    evt.stopPropagation();
  });

  // keyboard toggles
  el.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault(); toggleNode(n.id, true);
    }
  });

  // pointer drag
  el.addEventListener('pointerdown', pointerDown);
  board.appendChild(el);
  nodes[n.id] = { data: n, el };
}

/* create nodes */
nodesData.forEach(createNode);

/* create lines based on connections */
function createLines(){
  svg.innerHTML = '';
  lines.length = 0;
  nodesData.forEach(n=>{
    (n.connections || []).forEach(toId=>{
      if(!nodes[toId]) return;
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.classList.add('line');
      path.dataset.from = n.id;
      path.dataset.to = toId;
      path.setAttribute('fill','none');
      svg.appendChild(path);
      lines.push({ from: n.id, to: toId, el: path });
    });
  });
  updateAllLines();
}

/* compute center of element relative to board */
function getCenter(el){
  const rect = el.getBoundingClientRect();
  const boardRect = board.getBoundingClientRect();
  return { x: rect.left - boardRect.left + rect.width/2, y: rect.top - boardRect.top + rect.height/2 };
}

/* bezier path between centers */
function pathBetween(a,b){
  const dx = Math.abs(b.x - a.x);
  const curv = Math.min(260, dx * 0.5 + 40);
  const sx = a.x, sy = a.y, tx = b.x, ty = b.y;
  const hx1 = sx + ( (tx>sx) ? curv : -curv );
  const hx2 = tx - ( (tx>sx) ? curv : -curv );
  return `M ${sx} ${sy} C ${hx1} ${sy} ${hx2} ${ty} ${tx} ${ty}`;
}

/* update position of all lines */
function updateAllLines(){
  lines.forEach(l=>{
    const fromEl = nodes[l.from].el;
    const toEl = nodes[l.to].el;
    if(!fromEl || !toEl) return;
    const a = getCenter(fromEl);
    const b = getCenter(toEl);
    l.el.setAttribute('d', pathBetween(a,b));
    // add marker once
    if(!svg.querySelector('#arrowHead')){
      const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
      defs.innerHTML = `
        <marker id="arrowHead" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="7" markerHeight="7" orient="auto">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="${getComputedStyle(document.documentElement).getPropertyValue('--accent-ux') || '#3A5FCD'}"></path>
        </marker>`;
      svg.appendChild(defs);
    }
    l.el.setAttribute('marker-end','url(#arrowHead)');
  });
}

/* toggle node open/close and optionally open connected nodes */
function toggleNode(id, openConnected){
  const node = nodes[id];
  if(!node) return;
  const el = node.el;
  const isOpen = el.classList.contains('open');
  if(isOpen){
    el.classList.remove('open');
    el.setAttribute('aria-pressed','false');
    highlightConnections(id,false);
  } else {
    el.classList.add('open');
    el.setAttribute('aria-pressed','true');
    highlightConnections(id,true);
    if(openConnected){
      const cons = node.data.connections || [];
      cons.forEach(cid => {
        if(nodes[cid] && !nodes[cid].el.classList.contains('open')){
          nodes[cid].el.classList.add('open');
          nodes[cid].el.setAttribute('aria-pressed','true');
          highlightConnections(cid,true);
        }
      });
    }
    // bring to front
    el.style.zIndex = 60;
  }
}

/* highlight connections visually */
function highlightConnections(id,on){
  lines.forEach(l=>{
    if(l.from === id || l.to === id){
      if(on) l.el.classList.add('highlight');
      else l.el.classList.remove('highlight');
    } else {
      if(on) l.el.style.opacity = 0.25;
      else l.el.style.opacity = 0.95;
    }
  });
  Object.values(nodes).forEach(n=>{
    const shouldHighlight = (n.data.id === id) || ((nodes[id].data.connections||[]).includes(n.data.id));
    if(on && shouldHighlight) n.el.classList.add('highlight');
    else n.el.classList.remove('highlight');
  });
}

/* pointer drag implementation */
let dragState = null;
function pointerDown(e){
  if(e.button !== 0) return;
  const el = e.currentTarget;
  el.setPointerCapture(e.pointerId);
  const startX = e.clientX, startY = e.clientY;
  const rect = el.getBoundingClientRect();
  const boardRect = board.getBoundingClientRect();
  const offsetX = startX - rect.left;
  const offsetY = startY - rect.top;
  dragState = { el, offsetX, offsetY, rect, boardRect };
  el.dataset.dragging = 'false';

  function moveHandler(ev){
    ev.preventDefault();
    const nx = ev.clientX - dragState.boardRect.left - dragState.offsetX;
    const ny = ev.clientY - dragState.boardRect.top - dragState.offsetY;
    // bounds
    const maxX = board.clientWidth - dragState.rect.width - 12;
    const maxY = board.clientHeight - dragState.rect.height - 12;
    const boundedX = Math.max(8, Math.min(maxX, nx));
    const boundedY = Math.max(8, Math.min(maxY, ny));
    dragState.el.style.left = boundedX + 'px';
    dragState.el.style.top = boundedY + 'px';
    dragState.el.dataset.dragging = 'true';
    updateAllLines();
  }
  function upHandler(ev){
    el.removeEventListener('pointermove', moveHandler);
    el.removeEventListener('pointerup', upHandler);
    el.releasePointerCapture(ev.pointerId);
    savePositionsToStorage();
    setTimeout(()=> el.dataset.dragging = 'false', 20);
  }
  el.addEventListener('pointermove', moveHandler);
  el.addEventListener('pointerup', upHandler);
}

/* persist positions */
function savePositionsToStorage(){
  const pos = {};
  Object.values(nodes).forEach(n=>{
    pos[n.data.id] = { left: n.el.style.left, top: n.el.style.top };
  });
  localStorage.setItem('uxpremium.positions', JSON.stringify(pos));
}
function loadPositionsFromStorage(){
  const raw = localStorage.getItem('uxpremium.positions');
  if(!raw) return false;
  try{
    const pos = JSON.parse(raw);
    Object.entries(pos).forEach(([id,p])=>{
      if(nodes[id]) {
        nodes[id].el.style.left = p.left;
        nodes[id].el.style.top = p.top;
      }
    });
    updateAllLines();
    return true;
  }catch(e){ return false; }
}

/* reset and fit controls */
document.getElementById('reset').addEventListener('click', ()=>{
  nodesData.forEach(n=>{
    const el = nodes[n.id].el;
    el.style.left = n.x + 'px';
    el.style.top = n.y + 'px';
    el.classList.remove('open','highlight');
  });
  updateAllLines();
  localStorage.removeItem('uxpremium.positions');
});

document.getElementById('fit').addEventListener('click', ()=>{
  const first = nodes['central'].el;
  const wrap = document.getElementById('boardWrap');
  const rect = first.getBoundingClientRect();
  const wrapRect = wrap.getBoundingClientRect();
  const scrollX = rect.left - wrapRect.left - (wrapRect.width/2) + rect.width/2;
  const scrollY = rect.top - wrapRect.top - (wrapRect.height/2) + rect.height/2;
  wrap.scrollBy({ left: scrollX, top: scrollY, behavior:'smooth' });
});

/* close all on board click */
board.addEventListener('click', (e)=>{
  if(e.target === board || e.target === svg){
    Object.values(nodes).forEach(n => {
      n.el.classList.remove('open','highlight');
      n.el.setAttribute('aria-pressed','false');
    });
    lines.forEach(l => { l.el.classList.remove('highlight'); l.el.style.opacity = 0.95; });
  }
});

/* keyboard shortcuts */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){
    Object.values(nodes).forEach(n => {
      n.el.classList.remove('open','highlight');
      n.el.setAttribute('aria-pressed','false');
    });
    lines.forEach(l => { l.el.classList.remove('highlight'); l.el.style.opacity=0.95; });
  }
});

/* init */
createLines();
if(!loadPositionsFromStorage()){
  updateAllLines();
}
toggleNode('central', true);
window.addEventListener('resize', updateAllLines);

/* safety update while dragging */
setInterval(updateAllLines, 160);

</script>
</body>
</html>
